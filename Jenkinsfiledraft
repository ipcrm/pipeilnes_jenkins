#!groovy
import groovy.json.JsonOutput
import groovy.json.JsonSlurper

def DISTELLI_USERNAME = 'ipcrm'
def DISTELLI_API_URL  = "https://api.distelli.com/$DISTELLI_USERNAME"
def DISTELLI_APP_NAME = "pipeilnes_jenkins"

PIPELINES_API_TOKEN='ibmmox8a2mspxs5lzh3ozhwe9xyq0smslsmmg' //BAD!

def PIPELINES_PUSH_EVENT_ID = ''
def PIPELINES_BUILD_EVENT_ID = ''


node('pipelines') {
  checkout(scm).each { k,v -> env.setProperty(k, v) }
  env.GIT_AUTHOR_NAME = sh(returnStdout: true, script: "git --no-pager show -s --format='%an'").trim()
  def DISTELLI_CHANGE_TITLE = sh(returnStdout: true, script: 'git --no-pager log --pretty=format:"%s" -1')
  def DISTELLI_BUILD_ID = env.BUILD_NUMBER
  def DISTELLI_BUILD_URL= env.BUILD_URL
  def DISTELLI_CHANGE_AUTHOR = env.GIT_AUTHOR_NAME
  def DISTELLI_CHANGE_AUTHOR_DISPLAY_NAME = env.GIT_AUTHOR_NAME
  def DISTELLI_CHANGE_ID = env.GIT_COMMIT
  def DISTELLI_BRANCH_NAME = env.GIT_BRANCH.split('/')[1]
  def DISTELLI_CHANGE_TARGET = env.GIT_URL
  def DISTELLI_CHANGE_URL = "${env.GIT_URL}/commits/${DISTELLI_CHANGE_ID}"

  stage('Create Push Event'){
    def pipeargs = "apps/${DISTELLI_APP_NAME}/events/pushEvent?apiToken=${PIPELINES_API_TOKEN}"
    def data = [:]
    data['author_username'] = DISTELLI_CHANGE_AUTHOR
    data['author_name'] = DISTELLI_CHANGE_AUTHOR_DISPLAY_NAME
    data['commit_msg'] = DISTELLI_CHANGE_TITLE 
    data['commit_url'] = DISTELLI_CHANGE_URL
    data['repo_url']  = DISTELLI_CHANGE_TARGET
    data['commit_id'] = DISTELLI_CHANGE_ID 
    data['repo_owner'] = 'ipcrm' 
    data['repo_name'] = 'pipelines_jenkins'
    data['branch'] = DISTELLI_BRANCH_NAME

    PIPELINES_PUSH_EVENT_ID = pushData('PUT',DISTELLI_API_URL,pipeargs,data)['event_id']
  }

  stage('Create Build Event'){
    try {
      def DISTELLI_NOW = sh(returnStdout: true, script: 'date -u +%Y-%m-%dT%H:%M:%S.0Z').trim()
      def builddata = [:]
      builddata["build_status"] = 'running'
      builddata["build_start"] = DISTELLI_NOW
      builddata["build_id"] = DISTELLI_BUILD_ID
      builddata["build_provider"] = 'jenkins'
      builddata["build_url"] = DISTELLI_BUILD_URL
      builddata["repo_url"] = DISTELLI_CHANGE_TARGET 
      builddata["commit_url"] = DISTELLI_CHANGE_URL
      builddata["author_username"] = DISTELLI_CHANGE_AUTHOR
      builddata["author_name"] = DISTELLI_CHANGE_AUTHOR_DISPLAY_NAME
      builddata["commit_msg"] = DISTELLI_CHANGE_TITLE
      builddata["commit_id"] = DISTELLI_CHANGE_ID
      builddata["branch"] = DISTELLI_BRANCH_NAME
      builddata["parent_event_id"] = PIPELINES_PUSH_EVENT_ID
      echo 'IAMHERE'
      
      def pipeargs = "apps/${DISTELLI_APP_NAME}/events/buildEvent?apiToken=${PIPELINES_API_TOKEN}"
      PIPELINES_BUILD_EVENT_ID = pushData('PUT',DISTELLI_API_URL,pipeargs,builddata)['event_id']
      echo 'I am here - 2'

      // Customer Code
      //  Compile XYZ
      //  Package XYZ
      //  - Distelli Manifest, PkgInclude: *XYZ Artifacts*
      // End of Customer Code

      sh('distelli push -save-release release_version.out && echo "HI" && cat release_version.out')
      echo 'I am here - 3'
      DISTELLI_NOW = sh(returnStdout: true, script: 'date -u +%Y-%m-%dT%H:%M:%S.0Z').trim()
      echo 'I am here - 4'


      def eventdata = [:]
      eventdata['build_status'] = 'Succeeded'
      eventdata['build_end'] = DISTELLI_NOW
      eventdata['release_version'] = sh(returnStdout: true, script:'cat release_version.out')

      def eventargs = "apps/${DISTELLI_APP_NAME}/events/${PIPELINES_BUILD_EVENT_ID}?apiToken=${PIPELINES_API_TOKEN}"
      pushData('POST',DISTELLI_API_URL,eventargs,eventdata)

    } catch (all) {
        def DISTELLI_NOW = sh(returnStdout: true, script: 'date -u +%Y-%m-%dT%H:%M:%S.0Z').trim()

        def eventdata = [:]
        eventdata['build_status'] = 'Failed'
        eventdata['build_end'] = DISTELLI_NOW

        def eventargs = "apps/${DISTELLI_APP_NAME}/events/${PIPELINES_BUILD_EVENT_ID}?apiToken=${PIPELINES_API_TOKEN}"
        pushData('POST',DISTELLI_API_URL,eventargs,eventdata)

        error('Failed to build!')
      }
    }
}

def pushData (method,baseurl,args,payload) {
  def jsonSlurper = new JsonSlurper()
  try {
    def fullurl = "${baseurl}/${args}"
    def post = new URL(fullurl).openConnection();
    post.setRequestMethod(method)
    post.setDoOutput(true)
    post.setRequestProperty("Content-Type", "application/json")
    post.getOutputStream().write(JsonOutput.toJson(payload).getBytes("UTF-8"));
    echo JsonOutput.toJson(payload)
    echo fullurl
    def postRC = post.getResponseCode();
    if(postRC.equals(200)) {
      def object = jsonSlurper.parseText(post.getInputStream().getText());
      return object
    }else{
      error("POST to ${baseurl} failed! Response code ${postRC.toString()}")
    }
  } catch (Exception e) {
    throw e
  }
}
